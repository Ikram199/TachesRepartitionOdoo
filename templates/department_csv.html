<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CSV – {{ dept }}</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header>
      <h1>CSV – {{ dept }}</h1>
      <nav>
        <a href="/">Accueil</a>
        <a href="/departments" class="active">Départements</a>
      </nav>
    </header>
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul class="flash">
          {% for category, message in messages %}
            <li class="{{ category }}">{{ message }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
      <section>
        <h2>Fichiers du département</h2>
        <table class="grid">
          <thead>
            <tr><th>Type</th><th>Fichier actuel</th><th>Uploader</th><th>Modèle</th></tr>
          </thead>
          <tbody>
            {% for logical, default_name in files %}
            <tr>
              <td>{{ logical }}</td>
              <td><code>{{ paths.get(logical, '') }}</code></td>
              <td>
                <form method="POST" action="/departments/{{ dept }}/csv/upload?type={{ logical }}" enctype="multipart/form-data">
                  <input type="file" name="file" accept=".csv,text/csv" />
                  <button type="submit">Uploader</button>
                </form>
              </td>
              <td>
                <a class="btn" href="/departments/{{ dept }}/csv/template?type={{ logical }}&rows=5">Télécharger Modèle</a>
                {% if logical == 'tachessepare' %}
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;">

                </div>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if not file_only %}
        <form method="POST" action="/departments/{{ dept }}/csv/load" style="margin-top:12px;">
          <button type="submit">Charger ces CSV dans la base du département</button>
        </form>
        {% endif %}
      </section>
      <section>
        {% if not file_only %}
        <form method="GET" action="/departments/{{ dept }}/assign" style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
          <label>Max/jour
            <input type="number" name="max" min="1" step="1" value="50" style="width:90px; margin-left:6px;"/>
          </label>
          
          
          <button type="submit" style="margin-left:12px;">Lancer l'affectation</button>
        </form>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
          <a class="btn" href="/download?dept={{ dept }}">Télécharger l'assignation</a>
          <a class="btn" href="/departments/{{ dept }}/csv/fill-download?type=tachessepare&source=assign">Remplir tachessepare depuis l'assignation</a>
        </div>
        {% endif %}
      </section>
      {% if results %}
      <section>
        <h2>Résultats</h2>
        <pre class="output">{{ results|tojson(indent=2) }}</pre>
      </section>
      {% endif %}
    </main>
  </body>
  </html>

